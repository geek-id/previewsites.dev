user nobody;
worker_processes 1;

error_log logs/error.log;
pid logs/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log logs/access.log main;

    sendfile on;
    keepalive_timeout 65;

    server_tokens off;
    more_set_headers 'Server: PreviewSites.dev';

    lua_shared_dict preview_domains 10m;

    # =========================================================
    # HTTP Redirect to HTTPS for `previewsites.dev`
    # =========================================================
    server {
        listen 80;
        server_name previewsites.dev;

        return 301 https://previewsites.dev$request_uri;
    }

    # =========================================================
    # HTTP Server Block for `*.previewsites.dev` (Subdomains)
    # =========================================================
    server {
        listen 80;
        server_name ~^(?<preview_subdomain>[a-z0-9]+)\.previewsites\.dev$;

        return 301 https://$host$request_uri;
    }

    # =========================================================
    # HTTPS Server Block for `previewsites.dev` (Main Site)
    # =========================================================
    server {
        listen 443 ssl;
        server_name previewsites.dev;

        ssl_certificate /etc/letsencrypt/live/previewsites.dev/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/previewsites.dev/privkey.pem;

        access_log logs/host.access.log main;

        root    /var/www/public_html;
        index   index.html;

        location / {
            try_files $uri $uri/ /index.html;
        }

        location /style.css {
            root /var/www/public_html;
            add_header Content-Type text/css;
        }

        location /robots.txt {
            add_header Content-Type text/plain;
            return 200 "User-agent: *\nDisallow: /wp-admin/\nDisallow: /debug_dict\nAllow: /wp-admin/admin-ajax.php\n\nSitemap: https://previewsites.dev/sitemap_index.xml";
        }

        # API Endpoint: Generate a Random Subdomain for Each Preview
        location /create-preview {
            content_by_lua_block {
                local cjson = require("cjson")
                local ngx_shared = ngx.shared.preview_domains

                ngx.req.read_body()
                local body_data = ngx.req.get_body_data()
                local args = ngx.req.get_post_args()

                local args = {}
                    for key, value in string.gmatch(body_data, "Content%-Disposition: form%-data; name=\"([^\"]+)\"\r\n\r\n([^\r\n]+)") do
                    args[key] = value
                end

                local domain = args["domain"]
                local ip = args["ip"]
                if not domain or not ip then
                    ngx.status = ngx.HTTP_BAD_REQUEST
                    ngx.say("Error: Missing domain or IP Address")
                    return
                end

                -- Generate a unique, random preview subdomain
                local random_id = ngx.md5(tostring(math.random()) .. tostring(os.time())):sub(1, 10)
                local subdomain = random_id .. ".previewsites.dev"

                -- Store in shared dict (Expire in 3 hours)
                local success1, err1 = ngx_shared:set(random_id, ip, 10800)  -- Store IP
                local success2, err2 = ngx_shared:set(random_id .. "_domain", domain, 10800)  -- Store Domain

                -- Debugging Logs
                if not success1 then ngx.log(ngx.ERR, "[ERROR] Failed to store IP: ", err1) end
                if not success2 then ngx.log(ngx.ERR, "[ERROR] Failed to store Domain: ", err2) end

                -- Output HTML with copy button and styled components
                ngx.say([[
                    <div class="flex items-center w-96">
                        <span class="shrink-0 z-10 inline-flex items-center py-2.5 px-4 text-sm font-medium text-center text-gray-900 bg-gray-100 border border-gray-300 rounded-s-lg dark:bg-gray-600 dark:text-white dark:border-gray-600">URL</span>
                        <div class="relative w-full">
                            <input id="website-url" type="text" aria-describedby="helper-text-explanation" class="bg-gray-50 border border-e-0 border-gray-300 text-gray-500 dark:text-gray-400 text-sm border-s-0 focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:focus:ring-blue-500 dark:focus:border-blue-500" value="]] .. preview_url .. [[" readonly disabled />
                        </div>
                        <button data-tooltip-target="tooltip-website-url" data-copy-to-clipboard-target="website-url" class="shrink-0 z-10 inline-flex items-center py-3 px-4 text-sm font-medium text-center text-white bg-blue-700 rounded-e-lg hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 border border-blue-700 dark:border-blue-600 hover:border-blue-800 dark:hover:border-blue-700" type="button" onclick="navigator.clipboard.writeText(']] .. preview_url .. [[')">
                            <span id="default-icon">
                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 20">
                                    <path d="M16 1h-3.278A1.992 1.992 0 0 0 11 0H7a1.993 1.993 0 0 0-1.722 1H2a2 2 0 0 0-2 2v15a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2Zm-3 14H5a1 1 0 0 1 0-2h8a1 1 0 0 1 0 2Zm0-4H5a1 1 0 0 1 0-2h8a1 1 0 1 1 0 2Zm0-5H5a1 1 0 0 1 0-2h2V2h4v2h2a1 1 0 1 1 0 2Z"/>
                                </svg>
                            </span>
                            <span id="success-icon" class="hidden">
                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 12">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5.917 5.724 10.5 15 1.5"/>
                                </svg>
                            </span>
                        </button>
                        <div id="tooltip-website-url" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-xs opacity-0 tooltip dark:bg-gray-700">
                            <span id="default-tooltip-message">Copy link</span>
                            <span id="success-tooltip-message" class="hidden">Copied!</span>
                            <div class="tooltip-arrow" data-popper-arrow></div>
                        </div>
                    </div>
                    <p id="helper-text-explanation" class="mt-2 text-sm text-gray-500 dark:text-gray-400 w-96">Note: This preview link will be active for 3 hours and will be automatically deleted afterward.</p>
                ]])
            }
        }


        # Add Debug Page to Show Stored Preview Domains
            location /debug_dict {
                content_by_lua_block {
                    local shared_dict = ngx.shared.preview_domains
                    local keys = shared_dict:get_keys(0)  -- Get all stored keys

                    -- Set Content-Type for HTML output
                    ngx.header.content_type = "text/html"

                    ngx.say("<html><head><title>Stored Preview Domains</title></head><body>")
                    ngx.say("<h1>Stored Domains and IPs</h1>")
                    ngx.say("<table border='1'><tr><th>Subdomain</th><th>IP Address</th></tr>")

                    for _, key in ipairs(keys) do
                    local value = shared_dict:get(key)
                    ngx.say("<tr><td>" .. key .. "</td><td>" .. value .. "</td></tr>")
                    end

                    ngx.say("</table></body></html>")
                }
            }  
        }

    }

    # =========================================================
    # HTTPS Server Block for `*.previewsites.dev` (Subdomains)
    # =========================================================
    server {
        listen 443 ssl;
        server_name ~^(?<preview_subdomain>[a-z0-9]+)\.previewsites\.dev$;

        ssl_certificate /etc/letsencrypt/live/previewsites.dev/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/previewsites.dev/privkey.pem;

        set_by_lua_block $preview_domain {
            local preview_subdomain = ngx.var.preview_subdomain or ""
            if preview_subdomain == "" then return "" end

            local shared_dict = ngx.shared.preview_domains
            local domain = shared_dict:get(preview_subdomain .. "_domain")

            ngx.log(ngx.ERR, "[PREVIEW] Lookup: subdomain=", preview_subdomain, " -> domain=", domain or "None")
            return domain or ""
        }

       set_by_lua_block $backend {
             local preview_subdomain = ngx.var.preview_subdomain or ""
             if preview_subdomain == "" then return "" end

             local shared_dict = ngx.shared.preview_domains
             local ip = shared_dict:get(preview_subdomain)

             ngx.log(ngx.ERR, "[PREVIEW] Lookup: subdomain=", preview_subdomain, " -> IP=", ip or "None")
             return ip or ""
        }
 
        location / {
            if ($backend = "") {
                return 404 "No preview available for this domain";
            }

            proxy_pass http://$backend$request_uri;
            proxy_set_header Host $preview_domain;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	        proxy_set_header X-Forwarded-Proto $scheme;

            # Replace links inside HTML content
            sub_filter_once off;
            sub_filter "http://$preview_domain" "http://$host";
            sub_filter "https://$preview_domain" "https://$host";

            proxy_set_header Accept-Encoding "";
            proxy_buffering off;

            #add_header X-Backend-IP $backend;
            add_header X-Original-Host $host;
            add_header X-Expected-Host $preview_domain;
	        add_header 'Content-Security-Policy' 'upgrade-insecure-requests';
        }
    }
}