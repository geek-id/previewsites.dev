user nobody;
worker_processes 1;

error_log logs/error.log;
pid logs/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log logs/access.log main;

    sendfile on;
    keepalive_timeout 65;

    server_tokens off;
    more_set_headers 'Server: PreviewSites.dev';

    lua_shared_dict preview_domains 10m;

    # =========================================================
    # HTTP Redirect to HTTPS for `previewsites.dev`
    # =========================================================
    server {
        listen 80;
        server_name previewsites.dev;

        return 301 https://previewsites.dev$request_uri;
    }

    # =========================================================
    # HTTP Server Block for `*.previewsites.dev` (Subdomains)
    # =========================================================
    server {
        listen 80;
        server_name ~^(?<preview_subdomain>[a-z0-9]+)\.previewsites\.dev$;

        return 301 https://$host$request_uri;
    }

    # =========================================================
    # HTTPS Server Block for `previewsites.dev` (Main Site)
    # =========================================================
    server {
        listen 443 ssl;
        server_name previewsites.dev;

        ssl_certificate /etc/letsencrypt/live/previewsites.dev/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/previewsites.dev/privkey.pem;

        access_log logs/host.access.log main;

        root    /var/www/public_html;
        index   index.html;

        location / {
            try_files $uri $uri/ /index.html;
        }

        location /style.css {
            root /var/www/public_html;
            add_header Content-Type text/css;
        }

        # API Endpoint: Generate a Random Subdomain for Each Preview
        location /create-preview {
            content_by_lua_block {
                local cjson = require("cjson")
                local ngx_shared = ngx.shared.preview_domains

                ngx.req.read_body()
                local body_data = ngx.req.get_body_data()

                local args = {}
                    for key, value in string.gmatch(body_data, "Content%-Disposition: form%-data; name=\"([^\"]+)\"\r\n\r\n([^\r\n]+)") do
                    args[key] = value
                end

                local domain = args["domain"]
                local ip = args["ip"]
                if not domain or not ip then
                    ngx.status = ngx.HTTP_BAD_REQUEST
                    ngx.say("Error: Missing domain or IP Address")
                    return
                end

                -- Generate a unique, random preview subdomain
                local random_id = ngx.md5(tostring(math.random()) .. tostring(os.time())):sub(1, 10)
                local subdomain = random_id .. ".previewsites.dev"

                -- Store in shared dict (Expire in 3 hours)
                local success1, err1 = ngx_shared:set(random_id, ip, 10800)  -- Store IP
                local success2, err2 = ngx_shared:set(random_id .. "_domain", domain, 10800)  -- Store Domain

                -- Debugging Logs
                if not success1 then ngx.log(ngx.ERR, "[ERROR] Failed to store IP: ", err1) end
                if not success2 then ngx.log(ngx.ERR, "[ERROR] Failed to store Domain: ", err2) end

                ngx.say("Preview created: https://" .. subdomain)
            }
        }


        # Add Debug Page to Show Stored Preview Domains
        location /debug_dict {
            content_by_lua_block {
                local shared_dict = ngx.shared.preview_domains
                local keys = shared_dict:get_keys(0)  -- Get all stored keys

                -- Set Content-Type for HTML output
                ngx.header.content_type = "text/html"

                ngx.say("<html><head><title>Stored Preview Domains</title></head><body>")
                ngx.say("<h1>Stored Domains and IPs</h1>")
                ngx.say("<table border='1'><tr><th>Subdomain</th><th>IP Address</th></tr>")

                for _, key in ipairs(keys) do
                  local value = shared_dict:get(key)
                  ngx.say("<tr><td>" .. key .. "</td><td>" .. value .. "</td></tr>")
                end

                ngx.say("</table></body></html>")
            }
        }

    }

    # =========================================================
    # HTTPS Server Block for `*.previewsites.dev` (Subdomains)
    # =========================================================
    server {
        listen 443 ssl;
        server_name ~^(?<preview_subdomain>[a-z0-9]+)\.previewsites\.dev$;

        ssl_certificate /etc/letsencrypt/live/previewsites.dev/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/previewsites.dev/privkey.pem;

        set_by_lua_block $preview_domain {
            local preview_subdomain = ngx.var.preview_subdomain or ""
            if preview_subdomain == "" then return "" end

            local shared_dict = ngx.shared.preview_domains
            local domain = shared_dict:get(preview_subdomain .. "_domain")

            ngx.log(ngx.ERR, "[PREVIEW] Lookup: subdomain=", preview_subdomain, " -> domain=", domain or "None")
            return domain or ""
        }

       set_by_lua_block $backend {
             local preview_subdomain = ngx.var.preview_subdomain or ""
             if preview_subdomain == "" then return "" end

             local shared_dict = ngx.shared.preview_domains
             local ip = shared_dict:get(preview_subdomain)

             ngx.log(ngx.ERR, "[PREVIEW] Lookup: subdomain=", preview_subdomain, " -> IP=", ip or "None")
             return ip or ""
        }
 
        location / {
            if ($backend = "") {
                return 404 "No preview available for this domain";
            }

            proxy_pass http://$backend$request_uri;
            proxy_set_header Host $preview_domain;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Replace links inside HTML content
            sub_filter_once off;
            sub_filter "http://$preview_domain" "http://$host";
            sub_filter "https://$preview_domain" "https://$host";

            proxy_set_header Accept-Encoding "";
            proxy_buffering off;

            #add_header X-Backend-IP $backend;
            add_header X-Original-Host $host;
            add_header X-Expected-Host $preview_domain;
        }
    }
}