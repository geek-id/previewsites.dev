worker_processes auto;

events {
    worker_connections 1024;
}

http {
    lua_shared_dict site_previews 10m; # Shared memory to store mappings of subdomains to IPs

    server {
        listen 3019; 
        server_name previewsites.dev;

        root /usr/local/openresty/nginx/html;
        index index.html;

        location /create-preview {
            content_by_lua_block {
                local cjson = require("cjson")
                local ngx_shared = ngx.shared.site_previews

                -- Read POST data
                ngx.req.read_body()
                local args = ngx.req.get_post_args()

                -- Validate input
                local domain = args["domain"]
                local ip = args["ip"]
                if not domain or not ip then
                    ngx.status = ngx.HTTP_BAD_REQUEST
                    ngx.say("Error: Missing domain or IP Address")
                    return
                end

                -- Generate a unique subdomain (e.g., preview1234.previewsites.dev)
                local preview_id = tostring(math.random(1000,9999))
                local subdomain = "preview" .. preview_id .. "previewsites.dev"

                -- Store subdomain-IP mapping in shared memory with 3-hour TTL
                # local shared_dict = ngx.shared.preview_mapping
                # shared_dict:set(subdomain, ip, 3 * 60 * 60)
                local success, err = ngx_shared:set(subdomain, ip, 10800)
                if not success then
                    ngx.status = ngx.HTTP_INTERNAL_SERVER_ERROR
                    ngx.say("Error: Unable to store subdomain mapping: ", err)
                    return
                end

                -- Add the subdomain to CF via API
                local http = require("resty.http")
                local httpc = http.new()
                local cf_api_url = "https://api.cloudflare.com/client/v4/zones/34c15081af69adebf93e3c118957bd9e/dns_records"
                local cf_api_key = "bne129l4_pfDodq_hysrvvBukBgh1FqDk2gsrDBp"
                # local cf_email = "CF_EMAIL"

                local res, err = httpc:request_uri(cf_api_url, {
                    method = "POST",
                    body = cjson.encode({
                        type = "A",
                        name = subdomain,
                        content = ip,
                        ttl = 60, -- 3 hours TTL
                        proxied = false,
                    }),
                    headers = {
                        ["Authorization"] = "Bearer " .. cf_api_key,
                        ["Content-Type"] = "application/json",
                    },
                })

                if not res or res.status ~=200 then
                    ngx.status = ngx.HTTP_INTERNAL_SERVER_ERROR
                    ngx.say("Error: Unable to create DNS Record in Cloudflare: ", err or res.body)
                    return
                end

                -- Respond with success
                ngx.say("Preview created: https://" .. subdomain)
            }
        }

        location /cleanup-previews {
            content_by_lua_block {
                local ngx_shared = ngx.shared.site_previews
                local keys = ngx_shared:get_keys(0)

                for _. key in ipairs(keys) do
                    local ttl = ngx_shared:ttl(key)
                    if ttl == 0 then
                        -- Delete the subdomain in CF
                        local http = require("resty.http")
                        local httpc = http.new()
                        local cf_api_url = "https://api.cloudflare.com/client/v4/zones/Zone_ID/dns_records"
                        local cf_api_key = "CF_API_KEY"

                        local res, err = httpc:request_uri(cf_api_key, {
                            method = "DELETE",
                            headers = {
                                ["Authorization"] = "Bearer " .. cf_api_key,
                                ["Content-Type"] = "application/json",
                            },
                        })

                        if res and res.status == 200 then
                            ngx_shared:delete(key)  -- Delete the expired subdomain from shared memory
                        end
                    end
                end

                ngx.say("Expired previews cleaned up.")
            }
        }

        # Proxy requests for preview subdomains
        server {
            listen 3019;
            server_name ~^preview\d+\.previewsites\.dev$;

            location / {
                content_by_lua_block {
                    local ngx_shared = ngx_shared.site_previews
                    local subdomain = ngx.var.host
                    local ip = ngx_shared:get(subdomain)

                    if not ip then
                        ngx.status = ngx.HTTP_NOT_FOUND
                        ngx.say("Error: Subdomain not found or expired.")
                        return
                    end

                    ngx.var.target = ip
                }

                proxy_pass http:$target;
                proxy_set_header Host $host;
            }
        }
    }
} 